<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ–‡æœ¬ä¿å­˜ä¸­å¿ƒ - å¸¦åˆ†ç»„ä¸åˆ é™¤å¯†ç </title>
  <style>
    /* åŸºç¡€æ ·å¼çœç•¥ï¼Œä¸åŸæ–¹æ¡ˆä¸€è‡´ */
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .note-card {
      background: #f8f8f8;
      border-left: 5px solid #4CAF50;
      margin: 15px 0;
      padding: 15px 20px;
      border-radius: 4px;
    }
    .note-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #666;
    }
    .delete-btn {
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    .group-select {
      margin-top: 10px;
    }
    .password-modal {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .password-modal input {
      padding: 8px;
      width: 100%;
    }
    .password-modal button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ æ–‡æœ¬ä¿å­˜ä¸­å¿ƒ</h1>

  <form id="noteForm">
    <input type="text" id="mainText" placeholder="è¾“å…¥è¦ä¿å­˜çš„æ–‡æœ¬..." required>
    <input type="text" id="noteText" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
    <select id="groupSelect"></select>
    <button type="submit">ä¿å­˜</button>
  </form>

  <div class="group-select">
    <label for="groupFilter">é€‰æ‹©åˆ†ç»„ï¼š</label>
    <select id="groupFilter"></select>
    <input type="text" id="newGroup" placeholder="æ–°åˆ†ç»„åç§°">
    <button onclick="addNewGroup()">æ·»åŠ åˆ†ç»„</button>
  </div>

  <div id="notesContainer"></div>

  <div class="password-modal" id="passwordModal" style="display:none;">
    <p>è¯·è¾“å…¥åˆ é™¤å¯†ç ï¼š</p>
    <input type="password" id="deletePasswordInput" />
    <button onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
    <button onclick="closeModal()">å–æ¶ˆ</button>
  </div>

  <script>
    let noteToDelete = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadGroups();
      renderNotes();
      document.getElementById('noteForm').addEventListener('submit', saveNote);
      document.getElementById('groupFilter').addEventListener('change', renderNotes);
    });

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const h = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      return `${y}-${m}-${d} ${h}:${min}`;
    }

    function saveNote(e) {
      e.preventDefault();
      const content = document.getElementById('mainText').value.trim();
      const remark = document.getElementById('noteText').value.trim();
      const group = document.getElementById('groupSelect').value;

      if (!content) {
        alert('è¯·è¾“å…¥è¦ä¿å­˜çš„æ–‡æœ¬å†…å®¹ï¼');
        return;
      }

      const date = formatDate(new Date());
      const newNote = { content, remark, date, group };

      const notes = JSON.parse(localStorage.getItem('savedNotes') || '[]');
      notes.unshift(newNote);
      localStorage.setItem('savedNotes', JSON.stringify(notes));

      renderNotes();
      document.getElementById('noteForm').reset();
    }

    function renderNotes() {
      const container = document.getElementById('notesContainer');
      container.innerHTML = '';

      const notes = JSON.parse(localStorage.getItem('savedNotes') || '[]');
      const currentGroup = document.getElementById('groupFilter').value;

      notes.filter(n => n.group === currentGroup).forEach(note => {
        const card = document.createElement('div');
        card.className = 'note-card';

        card.innerHTML = `
          <div class="note-content">${note.content}</div>
          ${note.remark ? `<div style="margin:8px 0;">å¤‡æ³¨ï¼š${note.remark}</div>` : ''}
          <div class="note-footer">
            <span>ä¿å­˜æ—¶é—´ï¼š${note.date}</span>
            <span class="delete-btn" onclick="openDeleteModal(this)">åˆ é™¤</span>
          </div>
        `;

        card.dataset.note = JSON.stringify(note);
        container.appendChild(card);
      });
    }

    function openDeleteModal(btn) {
      noteToDelete = btn.closest('.note-card');
      document.getElementById('passwordModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('deletePasswordInput').value = '';
    }

    async function confirmDelete() {
      const input = document.getElementById('deletePasswordInput').value;
      const storedHash = localStorage.getItem('deletePasswordHash');

      if (!storedHash) {
        alert('æœªè®¾ç½®åˆ é™¤å¯†ç ');
        closeModal();
        return;
      }

      const encoder = new TextEncoder();
      const data = encoder.encode(input);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      if (hashHex === storedHash) {
        const note = JSON.parse(noteToDelete.dataset.note);
        const notes = JSON.parse(localStorage.getItem('savedNotes') || '[]');
        const index = notes.findIndex(n => n.content === note.content && n.date === note.date);
        if (index > -1) {
          notes.splice(index, 1);
          localStorage.setItem('savedNotes', JSON.stringify(notes));
          renderNotes();
        }
        closeModal();
      } else {
        alert('å¯†ç é”™è¯¯');
      }
    }

    function loadGroups() {
      const groups = JSON.parse(localStorage.getItem('noteGroups') || '["é»˜è®¤"]');
      const select = document.getElementById('groupSelect');
      const filter = document.getElementById('groupFilter');
      select.innerHTML = '';
      filter.innerHTML = '';

      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        select.appendChild(option);

        const option2 = document.createElement('option');
        option2.value = group;
        option2.textContent = group;
        filter.appendChild(option2);
      });
    }

    function addNewGroup() {
      const input = document.getElementById('newGroup');
      const name = input.value.trim();
      if (!name) return;

      const groups = JSON.parse(localStorage.getItem('noteGroups') || '["é»˜è®¤"]');
      if (!groups.includes(name)) {
        groups.push(name);
        localStorage.setItem('noteGroups', JSON.stringify(groups));
        loadGroups();
        input.value = '';
      }
    }

    function setDeletePassword() {
      const password = prompt('è¯·è¾“å…¥åˆ é™¤å¯†ç ï¼š');
      if (!password) return;

      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      crypto.subtle.digest('SHA-256', data).then(hashBuffer => {
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        localStorage.setItem('deletePasswordHash', hashHex);
        alert('åˆ é™¤å¯†ç å·²è®¾ç½®');
      });
    }
  </script>
</body>
</html>
