name: Sync Proxies to Supabase

on:
  # æ¯å¤©å‡Œæ™¨ 2:00 UTC è¿è¡Œï¼ˆå³åŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '8 */1 * * *'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè¿è¡Œ
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install node-fetch

      - name: Upload data to Supabase
        env:
          SUPABASE_URL: ${{ https://ubsdjmcnonsormczvtuq.supabase.co }}
          SUPABASE_KEY: ${{ secrets.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVic2RqbWNub25zb3JtY3p2dHVxIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mjg0MDQ4NCwiZXhwIjoyMDc4NDE2NDg0fQ.xfWJwVXgBs9m6BgY6Kc1OmRjzki8PxgdhWEUHeMVFG8 }}
        run: |
          cat << 'EOF' > upload.mjs
          import fetch from 'node-fetch';

          const SUPABASE_URL = process.env.SUPABASE_URL;
          const SUPABASE_KEY = process.env.SUPABASE_KEY;

          // è¯»å– JSON æ–‡ä»¶
          const fs = await import('fs').then(m => m.default);
          const data = JSON.parse(fs.readFileSync('data/proxies.json'));

          // æ¸…ç©ºæ—§æ•°æ®å¹¶æ’å…¥æ–°æ•°æ®
          const clearRes = await fetch(
            \`\${SUPABASE_URL}/rest/v1/proxies\`,
            {
              method: 'DELETE',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
              },
              body: JSON.stringify({})
            }
          );

          if (!clearRes.ok) {
            console.error('æ¸…ç©ºå¤±è´¥:', await clearRes.text());
            process.exit(1);
          }

          console.log('âœ… æ—§æ•°æ®å·²æ¸…é™¤');

          const insertRes = await fetch(
            \`\${SUPABASE_URL}/rest/v1/proxies\`,
            {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=ignore-duplicates'
              },
              body: JSON.stringify(data)
            }
          );

          if (!insertRes.ok) {
            console.error('æ’å…¥å¤±è´¥:', await insertRes.text());
            process.exit(1);
          }

          console.log('ğŸ‰ æ•°æ®æˆåŠŸåŒæ­¥åˆ° Supabaseï¼');
          EOF

          # è¿è¡Œè„šæœ¬
          node upload.mjs
